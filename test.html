<!DOCTYPE html>
<html>
<head>
    <title>iframe Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        #logs { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>iframe埋め込みテスト</h1>
    
    <div id="status" class="status info">テスト開始中...</div>
    <div id="logs"></div>
    
    <div style="margin: 10px 0;">
        <button onclick="testIframeAPI()">iframe診断APIテスト</button>
        <button onclick="testIframeStatus()">iframe状況確認</button>
        <button onclick="testHeaders()">ヘッダー設定確認</button>
        <button onclick="switchToEmbedPage()">iframe専用ページに切り替え</button>
        <button onclick="switchToMainPage()">メインページに切り替え</button>
        <button onclick="clearLogs()">ログクリア</button>
    </div>
    
    <hr>
    
    <iframe 
        id="testIframe"
        src="https://kashiwabaragpt.azurewebsites.net" 
        width="100%" 
        height="600px" 
        frameborder="0"
        onload="onIframeLoad()"
        onerror="onIframeError()">
    </iframe>
    
    <script>
        const statusDiv = document.getElementById('status');
        const logsDiv = document.getElementById('logs');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function clearLogs() {
            logsDiv.innerHTML = '';
        }
        
        // iframe読み込み成功
        function onIframeLoad() {
            log('iframe読み込み成功');
            updateStatus('iframe読み込み成功', 'success');
        }
        
        // iframe読み込みエラー
        function onIframeError() {
            log('iframe読み込みエラー');
            updateStatus('iframe読み込みエラー', 'error');
        }
        
        // iframe診断APIテスト
        async function testIframeAPI() {
            try {
                log('iframe診断APIを呼び出し中...');
                const response = await fetch('https://kashiwabaragpt.azurewebsites.net/api/iframe-test');
                const data = await response.json();
                
                log('iframe診断API結果:');
                log(`- allowEmbedding: ${data.iframe?.allowEmbedding}`);
                log(`- allowedFrameAncestors: ${data.iframe?.allowedFrameAncestors}`);
                log(`- detected: ${data.iframe?.detected}`);
                log(`- environment.allowIframeEmbedding: ${data.environment?.allowIframeEmbedding}`);
                
                if (data.iframe?.allowEmbedding) {
                    updateStatus('iframe埋め込み設定: 有効', 'success');
                } else {
                    updateStatus('iframe埋め込み設定: 無効', 'error');
                }
            } catch (error) {
                log(`iframe診断APIエラー: ${error.message}`);
                updateStatus('iframe診断APIエラー', 'error');
            }
        }
        
        // iframe状況確認APIテスト
        async function testIframeStatus() {
            try {
                log('iframe状況確認APIを呼び出し中...');
                const response = await fetch('https://kashiwabaragpt.azurewebsites.net/api/iframe-status');
                const data = await response.json();
                
                log('iframe状況確認API結果:');
                log(`- detected: ${data.iframe?.detected}`);
                log(`- message: ${data.message}`);
                log(`- referer: ${data.headers?.referer}`);
                log(`- secFetchDest: ${data.headers?.secFetchDest}`);
                
            } catch (error) {
                log(`iframe状況確認APIエラー: ${error.message}`);
            }
        }
        
        // iframe専用ページに切り替え
        function switchToEmbedPage() {
            log('iframe専用ページに切り替え中...');
            document.getElementById('testIframe').src = 'https://kashiwabaragpt.azurewebsites.net/iframe-embed';
        }
        
        // メインページに切り替え
        function switchToMainPage() {
            log('メインページに切り替え中...');
            document.getElementById('testIframe').src = 'https://kashiwabaragpt.azurewebsites.net';
        }
        
        // ヘッダー設定確認
        async function testHeaders() {
            log('ヘッダー設定確認APIを呼び出し中...');
            try {
                const response = await fetch('https://kashiwabaragpt.azurewebsites.net/api/headers-test');
                const data = await response.json();
                
                if (data.success) {
                    log('ヘッダー設定確認API結果:');
                    log(`- allowIframeEmbedding: ${data.config.allowIframeEmbedding}`);
                    log(`- allowedFrameAncestors: ${data.config.allowedFrameAncestors}`);
                    log(`- X-Frame-Options: ${data.headers['X-Frame-Options'] || 'なし'}`);
                    log(`- Content-Security-Policy: ${data.headers['Content-Security-Policy'] || 'なし'}`);
                    log(`- Access-Control-Allow-Origin: ${data.headers['Access-Control-Allow-Origin'] || 'なし'}`);
                    log(`- message: ${data.message}`);
                    updateStatus(`ヘッダー確認完了: ${data.message}`, 'success');
                } else {
                    log(`ヘッダー設定確認APIエラー: ${data.error}`);
                    updateStatus('ヘッダー確認失敗', 'error');
                }
            } catch (error) {
                log(`ヘッダー設定確認APIエラー: ${error.message}`);
                updateStatus('ヘッダー確認失敗', 'error');
            }
        }
        
        // iframe内からのメッセージを受信
        window.addEventListener('message', function(event) {
            log(`iframe message received: ${JSON.stringify(event.data)}`);
        });
        
        // iframe読み込み監視
        window.addEventListener('load', function() {
            log('ページ読み込み完了');
            
            // 5秒後にiframe診断APIを自動実行
            setTimeout(testIframeAPI, 5000);
        });
        
        // エラー監視
        window.addEventListener('error', function(event) {
            log(`Global error: ${event.error?.message || event.message}`);
        });
        
        log('iframe テストページ初期化完了');
    </script>
</body>
</html>